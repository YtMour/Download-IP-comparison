# 📚 多站点IP验证下载系统 - 完整项目文档

## 🎯 项目概述

### 系统简介
多站点IP验证下载系统是一个企业级的文件下载管理平台，采用双系统分离架构，支持多个软件库分站的统一管理和IP验证下载控制。

### 核心特性
- **🏢 双系统分离** - 总后端系统 + 站点拦截系统
- **🔐 智能IP验证** - 防止跨地区滥用和盗链
- **🚀 预生成下载器** - GUI界面，用户体验友好
- **⚙️ 统一管理** - 总后台控制所有分站功能
- **📊 企业级统计** - 完整的下载记录和分析
- **🛡️ 多重安全** - API密钥、令牌过期、下载限制

## 🏗️ 系统架构

### 架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    用户访问流程                              │
├─────────────────────────────────────────────────────────────┤
│ 1. 用户访问分站 → 2. 点击下载链接 → 3. JS拦截器处理        │
│ 4. 生成下载器 → 5. 用户运行下载器 → 6. IP验证 → 7. 下载    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────┐    ┌─────────────────────┐
│   总后端系统        │    │   站点拦截系统      │
│  (dw.ytmour.art)    │    │  (各分站域名)       │
├─────────────────────┤    ├─────────────────────┤
│ • 统一数据库        │◄──►│ • JavaScript拦截器  │
│ • API接口服务       │    │ • PHP处理器         │
│ • 管理面板          │    │ • 配置文件          │
│ • 下载器生成        │    │ • 测试页面          │
│ • 统计分析          │    │ • 调试工具          │
└─────────────────────┘    └─────────────────────┘
```

### 技术栈
- **后端**: PHP 7.4+, MySQL 5.7+
- **前端**: HTML5, CSS3, JavaScript ES6+
- **下载器**: Python 3.7+, Tkinter
- **服务器**: Nginx, 宝塔面板
- **安全**: HTTPS, API密钥, JWT令牌

## 📁 项目结构

```
Download-IP-comparison/
├── README.md                           # 项目说明
├── 项目优化分析报告.md                  # 优化分析
├── 优化实施方案.md                     # 实施方案
├── 完整项目文档.md                     # 本文档
├── 宝塔面板缓存清理指南.md              # 缓存清理
│
├── 1-总后端系统/                       # 总后端系统
│   ├── README_后端部署.md              # 部署指南
│   ├── 后端部署脚本.sh                 # 自动部署
│   ├── config_simple.ini               # 简化配置
│   ├── convert_config.php              # 配置转换
│   ├── debug_api.php                   # API调试
│   ├── test_admin.php                  # 管理测试
│   │
│   ├── admin/                          # 管理面板
│   │   ├── index.php                   # 管理首页
│   │   ├── config_master.php           # 主配置文件
│   │   ├── database_manager.php        # 数据库管理
│   │   ├── database.php                # 数据库操作
│   │   ├── backup.php                  # 备份功能
│   │   ├── logs.php                    # 日志查看
│   │   └── api-docs.php                # API文档
│   │
│   ├── api/                            # API接口
│   │   └── download_api.php            # 核心API
│   │
│   └── downloader/                     # 下载器
│       ├── README_下载器.md            # 下载器说明
│       ├── downloader.py               # 下载器源码
│       ├── downloader.exe              # 编译版本
│       ├── config.ini                  # 配置模板
│       └── build.bat                   # 编译脚本
│
└── 2-站点拦截系统/                     # 站点拦截系统
    ├── interceptor.js                  # 拦截器v8.0
    ├── download_interceptor_new.js     # 新版拦截器
    ├── handler.php                     # 处理器
    ├── check.php                       # 环境检查
    ├── debug_site.php                  # 站点调试
    ├── clear_cache.php                 # 缓存清理
    ├── config.html                     # 配置界面
    ├── test.html                       # 测试页面
    ├── test_download_v8.html           # v8.0测试页
    ├── test_config.php                 # 配置测试
    └── test_params.html                # 参数测试
```

## 🚀 部署指南

### 第一步：总后端系统部署

#### 1.1 环境要求
- PHP 7.4+ (推荐 8.0+)
- MySQL 5.7+ (推荐 8.0+)
- Nginx 1.18+
- SSL证书 (必须)
- 宝塔面板 (推荐)

#### 1.2 快速部署
```bash
# 1. 上传文件到服务器
cd /www/wwwroot/dw.ytmour.art/
git clone <repository> .

# 2. 运行自动部署脚本
cd 1-总后端系统/
chmod +x 后端部署脚本.sh
./后端部署脚本.sh

# 3. 设置权限
chmod 777 downloads/
chmod 777 files/
chown -R www:www .

# 4. 配置SSL证书
# 在宝塔面板中为域名申请SSL证书
```

#### 1.3 手动配置
```php
// 编辑 admin/config_master.php
return [
    'storage_server' => [
        'domain' => 'https://dw.ytmour.art',
    ],
    'database' => [
        'host' => 'localhost',
        'database' => 'multi_site_downloads',
        'username' => 'your_username',
        'password' => 'your_password',
    ],
    // ... 其他配置
];
```

### 第二步：站点拦截系统部署

#### 2.1 文件上传
```bash
# 上传到各分站
scp -r 2-站点拦截系统/* user@分站服务器:/www/wwwroot/分站域名/
```

#### 2.2 配置设置
```javascript
// 方法1: 使用config.html配置界面
访问: https://分站域名/config.html

// 方法2: 直接编辑config.json
{
    "site_name": "分站名称",
    "site_key": "site_key",
    "api_key": "your_api_key",
    "storage_server": "https://dw.ytmour.art"
}
```

#### 2.3 集成到网站
```html
<!-- 在网站页面中添加拦截器 -->
<script src="interceptor.js?v=8.0"></script>
```

## 🔧 配置说明

### 总后端配置

#### 数据库配置
```php
'database' => [
    'type' => 'mysql',
    'host' => 'localhost',
    'port' => 3306,
    'database' => 'multi_site_downloads',
    'username' => 'download_admin',
    'password' => 'secure_password',
    'charset' => 'utf8mb4',
    'prefix' => 'msd_'
]
```

#### 站点配置
```php
'sites' => [
    'home' => [
        'name' => '主软件库',
        'domain' => 'home.ytmour.art',
        'api_key' => 'home_a1b2c3d4e5f6g7h8_20250101',
        'status' => 'active'
    ],
    'games' => [
        'name' => '游戏软件库',
        'domain' => 'games.ytmour.art',
        'api_key' => 'games_x9y8z7w6v5u4t3s2_20250101',
        'status' => 'active'
    ]
]
```

#### IP验证配置
```php
'ip_verification' => [
    'enabled' => true,
    'strict_mode' => false,
    'max_downloads_per_token' => 5,
    'token_expiry_hours' => 24,
    'allow_ip_change' => false
]
```

### 站点拦截配置

#### 基础配置
```json
{
    "site_name": "软件库分站",
    "site_key": "unique_site_key",
    "api_key": "your_api_key_here",
    "storage_server": "https://dw.ytmour.art",
    "demo_mode": false
}
```

#### 拦截规则配置
```javascript
// 在interceptor.js中配置拦截规则
const interceptPatterns = [
    /https:\/\/dw\.ytmour\.art\/windows\/.*\.(exe|msi|zip|rar|7z)$/i,
    /https:\/\/files\.example\.com\/.*\.(exe|msi)$/i
];

const excludePatterns = [
    '/downloads/',
    'downloader',
    '.php',
    'javascript:',
    'mailto:'
];
```

## 🔐 安全机制

### API安全
- **API密钥验证** - 每个站点独立密钥
- **请求签名** - HMAC-SHA256签名验证
- **时间戳验证** - 防重放攻击
- **频率限制** - API调用频率控制

### IP验证机制
- **严格模式** - IP完全匹配
- **宽松模式** - 允许同网段IP
- **地理位置验证** - 防跨地区滥用
- **设备指纹** - 多重身份验证

### 下载控制
- **令牌过期** - 时间限制
- **下载次数** - 次数限制
- **文件验证** - 防止直链访问
- **日志审计** - 完整操作记录

## 📊 监控与统计

### 系统监控
- **服务器状态** - CPU、内存、磁盘
- **API性能** - 响应时间、错误率
- **数据库性能** - 查询时间、连接数
- **网络状态** - 带宽使用、连接数

### 业务统计
- **下载统计** - 按时间、地区、软件分类
- **用户行为** - 访问路径、停留时间
- **错误分析** - 失败原因、频率统计
- **趋势分析** - 增长趋势、热门软件

### 报表功能
- **实时大屏** - 关键指标展示
- **定期报告** - 日报、周报、月报
- **自定义报表** - 按需生成
- **数据导出** - Excel、CSV格式

## 🧪 测试验证

### 功能测试
```bash
# 1. 访问测试页面
https://分站域名/test.html

# 2. 点击测试下载链接
- Adobe Photoshop 2024 v25.0.0
- Steam 游戏平台
- PotPlayer v1.7.21564
- Microsoft Office 2024 Professional

# 3. 验证下载流程
- 自动生成下载器
- 文件名包含版本号
- IP验证正常
- 下载成功完成
```

### 性能测试
```bash
# API性能测试
curl -X POST "https://dw.ytmour.art/api/download_api.php?action=create" \
  -H "X-API-Key: your_api_key" \
  -d "file_url=test_url&software_name=test_software"

# 并发测试
ab -n 1000 -c 10 "https://dw.ytmour.art/api/download_api.php?action=stats"
```

### 安全测试
```bash
# SQL注入测试
sqlmap -u "https://dw.ytmour.art/api/download_api.php" --data="token=test"

# XSS测试
# 在输入框中测试 <script>alert('xss')</script>

# API安全测试
# 测试无效API密钥、过期令牌等
```

## 🚨 故障排除

### 常见问题

#### 1. 401认证失败
**症状**: IP验证时返回401错误
**原因**: API密钥无效或站点未识别
**解决**: 
```bash
# 检查API密钥配置
grep -r "api_key" config.json
# 检查站点注册状态
mysql -e "SELECT * FROM msd_sites WHERE api_key='your_key'"
```

#### 2. 下载器生成失败
**症状**: 点击下载无响应或报错
**原因**: JavaScript拦截器未加载或配置错误
**解决**:
```javascript
// 检查拦截器加载
console.log(window.downloadInterceptorNew);
// 清理缓存重新加载
location.reload(true);
```

#### 3. IP验证失败
**症状**: 下载器提示IP验证失败
**原因**: IP地址变化或验证逻辑错误
**解决**:
```php
// 检查IP验证配置
$config['ip_verification']['strict_mode'] = false;
// 查看详细日志
tail -f /var/log/nginx/error.log
```

### 调试工具

#### 1. 站点调试工具
```bash
# 访问调试页面
https://分站域名/debug_site.php
```

#### 2. API调试工具
```bash
# 访问API调试页面
https://dw.ytmour.art/debug_api.php
```

#### 3. 缓存清理工具
```bash
# 访问缓存清理页面
https://分站域名/clear_cache.php
```

## 📈 性能优化

### 已实施优化
- ✅ 数据库索引优化
- ✅ 文件名版本号支持
- ✅ 缓存清理机制
- ✅ 重复下载问题修复
- ✅ API错误处理改进

### 计划优化
- 🔄 Redis缓存系统
- 🔄 CDN静态资源加速
- 🔄 数据库读写分离
- 🔄 微服务架构改造
- 🔄 实时监控告警

## 📞 技术支持

### 联系方式
- **技术文档**: 查看项目README和相关文档
- **问题反馈**: 通过GitHub Issues提交
- **紧急支持**: 查看故障排除章节

### 维护建议
- **定期备份** - 数据库和配置文件
- **日志监控** - 关注错误日志和性能指标
- **安全更新** - 及时更新PHP和MySQL版本
- **性能调优** - 根据使用情况调整配置

---

**文档版本**: v2.0  
**最后更新**: 2025-01-09  
**适用版本**: 系统v8.0+
