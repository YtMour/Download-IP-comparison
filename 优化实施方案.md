# ğŸš€ ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ - å…·ä½“è¡ŒåŠ¨è®¡åˆ’

## ğŸ“‹ ç¬¬ä¸€é˜¶æ®µä¼˜åŒ– (é«˜ä¼˜å…ˆçº§ - 1-2å‘¨)

### 1. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

#### 1.1 ç´¢å¼•ä¼˜åŒ–
```sql
-- åˆ›å»ºä¼˜åŒ–ç´¢å¼•è„šæœ¬
-- æ–‡ä»¶: database_optimization.sql

-- ä¸‹è½½è¡¨ç´¢å¼•
CREATE INDEX idx_downloads_site_token ON msd_downloads(site_id, token);
CREATE INDEX idx_downloads_ip_time ON msd_downloads(original_ip, created_at);
CREATE INDEX idx_downloads_expires ON msd_downloads(expires_at);

-- ç«™ç‚¹è¡¨ç´¢å¼•
CREATE INDEX idx_sites_api_key ON msd_sites(api_key);
CREATE INDEX idx_sites_status ON msd_sites(status);

-- æ—¥å¿—è¡¨ç´¢å¼•
CREATE INDEX idx_logs_site_time ON msd_system_logs(site_id, created_at);
CREATE INDEX idx_logs_level ON msd_system_logs(level);
```

#### 1.2 æŸ¥è¯¢ä¼˜åŒ–
```php
// æ–‡ä»¶: optimized_queries.php
class OptimizedQueries {
    // ä¼˜åŒ–å‰ï¼šN+1æŸ¥è¯¢é—®é¢˜
    // ä¼˜åŒ–åï¼šä½¿ç”¨JOINå‡å°‘æŸ¥è¯¢æ¬¡æ•°
    public function getDownloadsWithSites($limit = 100) {
        $sql = "
            SELECT d.*, s.name as site_name, s.domain 
            FROM msd_downloads d 
            JOIN msd_sites s ON d.site_id = s.id 
            WHERE d.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
            ORDER BY d.created_at DESC 
            LIMIT ?
        ";
        return $this->db->prepare($sql)->execute([$limit]);
    }
}
```

### 2. APIå®‰å…¨å¢å¼º

#### 2.1 JWTè®¤è¯ç³»ç»Ÿ
```php
// æ–‡ä»¶: 1-æ€»åç«¯ç³»ç»Ÿ/api/auth_service.php
class JWTAuthService {
    private $secretKey;
    
    public function generateToken($siteId, $apiKey) {
        $payload = [
            'site_id' => $siteId,
            'api_key' => hash('sha256', $apiKey),
            'iat' => time(),
            'exp' => time() + 3600, // 1å°æ—¶è¿‡æœŸ
            'jti' => uniqid() // é˜²é‡æ”¾æ”»å‡»
        ];
        
        return $this->encodeJWT($payload);
    }
    
    public function validateToken($token) {
        try {
            $payload = $this->decodeJWT($token);
            
            // éªŒè¯è¿‡æœŸæ—¶é—´
            if ($payload['exp'] < time()) {
                throw new Exception('Tokenå·²è¿‡æœŸ');
            }
            
            // éªŒè¯ç«™ç‚¹
            return $this->validateSite($payload['site_id'], $payload['api_key']);
            
        } catch (Exception $e) {
            return false;
        }
    }
}
```

#### 2.2 è¯·æ±‚ç­¾åéªŒè¯
```php
// æ–‡ä»¶: 1-æ€»åç«¯ç³»ç»Ÿ/api/signature_validator.php
class SignatureValidator {
    public function validateRequest($apiKey, $timestamp, $signature, $body) {
        // é˜²é‡æ”¾æ”»å‡» - æ—¶é—´æˆ³éªŒè¯
        if (abs(time() - $timestamp) > 300) { // 5åˆ†é’Ÿå†…æœ‰æ•ˆ
            throw new Exception('è¯·æ±‚æ—¶é—´æˆ³æ— æ•ˆ');
        }
        
        // ç”Ÿæˆç­¾å
        $expectedSignature = hash_hmac('sha256', 
            $timestamp . $body, 
            $apiKey
        );
        
        // é˜²æ—¶åºæ”»å‡»çš„å®‰å…¨æ¯”è¾ƒ
        if (!hash_equals($expectedSignature, $signature)) {
            throw new Exception('ç­¾åéªŒè¯å¤±è´¥');
        }
        
        return true;
    }
}
```

### 3. ç›‘æ§å‘Šè­¦ç³»ç»Ÿ

#### 3.1 ç³»ç»Ÿç›‘æ§
```php
// æ–‡ä»¶: 1-æ€»åç«¯ç³»ç»Ÿ/monitor/system_monitor.php
class SystemMonitor {
    public function checkSystemHealth() {
        $health = [
            'database' => $this->checkDatabase(),
            'disk_space' => $this->checkDiskSpace(),
            'memory_usage' => $this->checkMemoryUsage(),
            'api_response_time' => $this->checkAPIResponseTime(),
            'error_rate' => $this->checkErrorRate()
        ];
        
        // å‘é€å‘Šè­¦
        foreach ($health as $component => $status) {
            if ($status['status'] === 'critical') {
                $this->sendAlert($component, $status);
            }
        }
        
        return $health;
    }
    
    private function sendAlert($component, $status) {
        // é‚®ä»¶å‘Šè­¦
        $this->sendEmailAlert($component, $status);
        
        // é’‰é’‰å‘Šè­¦
        $this->sendDingTalkAlert($component, $status);
    }
}
```

#### 3.2 æ€§èƒ½ç›‘æ§
```php
// æ–‡ä»¶: 1-æ€»åç«¯ç³»ç»Ÿ/monitor/performance_monitor.php
class PerformanceMonitor {
    public function logAPICall($endpoint, $duration, $status) {
        $data = [
            'endpoint' => $endpoint,
            'duration_ms' => $duration,
            'status' => $status,
            'timestamp' => microtime(true),
            'memory_usage' => memory_get_peak_usage(true),
            'cpu_usage' => sys_getloadavg()[0]
        ];
        
        // è®°å½•åˆ°ç›‘æ§æ•°æ®åº“
        $this->recordMetrics($data);
        
        // æ…¢æŸ¥è¯¢å‘Šè­¦
        if ($duration > 1000) { // è¶…è¿‡1ç§’
            $this->alertSlowQuery($endpoint, $duration);
        }
    }
}
```

### 4. ä»£ç è´¨é‡æå‡

#### 4.1 é”™è¯¯å¤„ç†æ ‡å‡†åŒ–
```php
// æ–‡ä»¶: 1-æ€»åç«¯ç³»ç»Ÿ/core/error_handler.php
class ErrorHandler {
    public static function handleException($exception) {
        $error = [
            'error_id' => uniqid(),
            'message' => $exception->getMessage(),
            'code' => $exception->getCode(),
            'file' => $exception->getFile(),
            'line' => $exception->getLine(),
            'trace' => $exception->getTraceAsString(),
            'timestamp' => date('Y-m-d H:i:s'),
            'request_id' => $_SERVER['HTTP_X_REQUEST_ID'] ?? uniqid()
        ];
        
        // è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
        error_log(json_encode($error));
        
        // è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'error_id' => $error['error_id'],
            'message' => 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
            'timestamp' => $error['timestamp']
        ]);
    }
}
```

#### 4.2 é…ç½®ç®¡ç†ä¼˜åŒ–
```php
// æ–‡ä»¶: 1-æ€»åç«¯ç³»ç»Ÿ/core/config_manager.php
class ConfigManager {
    private static $config = null;
    private static $cache = [];
    
    public static function get($key, $default = null) {
        if (self::$config === null) {
            self::loadConfig();
        }
        
        // æ”¯æŒç‚¹å·åˆ†éš”çš„åµŒå¥—é”®
        $keys = explode('.', $key);
        $value = self::$config;
        
        foreach ($keys as $k) {
            if (!isset($value[$k])) {
                return $default;
            }
            $value = $value[$k];
        }
        
        return $value;
    }
    
    private static function loadConfig() {
        $cacheKey = 'config_' . filemtime(__DIR__ . '/../admin/config_master.php');
        
        if (isset(self::$cache[$cacheKey])) {
            self::$config = self::$cache[$cacheKey];
            return;
        }
        
        self::$config = require __DIR__ . '/../admin/config_master.php';
        self::$cache[$cacheKey] = self::$config;
    }
}
```

## ğŸ“‹ ç¬¬äºŒé˜¶æ®µä¼˜åŒ– (ä¸­ä¼˜å…ˆçº§ - 3-4å‘¨)

### 1. ç¼“å­˜ç³»ç»Ÿå®æ–½

#### 1.1 Redisç¼“å­˜å±‚
```php
// æ–‡ä»¶: 1-æ€»åç«¯ç³»ç»Ÿ/cache/redis_cache.php
class RedisCache {
    private $redis;
    
    public function __construct() {
        $this->redis = new Redis();
        $this->redis->connect('127.0.0.1', 6379);
    }
    
    public function cacheAPIResponse($key, $data, $ttl = 300) {
        $this->redis->setex($key, $ttl, json_encode($data));
    }
    
    public function getCachedResponse($key) {
        $cached = $this->redis->get($key);
        return $cached ? json_decode($cached, true) : null;
    }
    
    public function invalidateCache($pattern) {
        $keys = $this->redis->keys($pattern);
        if ($keys) {
            $this->redis->del($keys);
        }
    }
}
```

#### 1.2 æ–‡ä»¶ç¼“å­˜ä¼˜åŒ–
```php
// æ–‡ä»¶: 2-ç«™ç‚¹æ‹¦æˆªç³»ç»Ÿ/cache/file_cache.php
class FileCache {
    private $cacheDir;
    
    public function __construct($cacheDir = './cache') {
        $this->cacheDir = $cacheDir;
        if (!is_dir($cacheDir)) {
            mkdir($cacheDir, 0755, true);
        }
    }
    
    public function get($key) {
        $file = $this->getCacheFile($key);
        
        if (!file_exists($file)) {
            return null;
        }
        
        $data = json_decode(file_get_contents($file), true);
        
        // æ£€æŸ¥è¿‡æœŸæ—¶é—´
        if ($data['expires'] < time()) {
            unlink($file);
            return null;
        }
        
        return $data['value'];
    }
    
    public function set($key, $value, $ttl = 3600) {
        $file = $this->getCacheFile($key);
        $data = [
            'value' => $value,
            'expires' => time() + $ttl,
            'created' => time()
        ];
        
        file_put_contents($file, json_encode($data));
    }
}
```

### 2. ç•Œé¢ä¼˜åŒ–æ”¹è¿›

#### 2.1 å“åº”å¼è®¾è®¡
```html
<!-- æ–‡ä»¶: 2-ç«™ç‚¹æ‹¦æˆªç³»ç»Ÿ/templates/modern_ui.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°ä»£åŒ–ä¸‹è½½ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        .download-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .download-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bs-body-bg: #1a1a1a;
                --bs-body-color: #ffffff;
            }
        }
    </style>
</head>
<body>
    <!-- ç°ä»£åŒ–ç•Œé¢å†…å®¹ -->
</body>
</html>
```

#### 2.2 å®æ—¶è¿›åº¦æ˜¾ç¤º
```javascript
// æ–‡ä»¶: 2-ç«™ç‚¹æ‹¦æˆªç³»ç»Ÿ/js/progress_tracker.js
class ProgressTracker {
    constructor() {
        this.downloads = new Map();
        this.initWebSocket();
    }
    
    initWebSocket() {
        // å®æ—¶è¿›åº¦æ›´æ–°
        this.ws = new WebSocket('wss://dw.ytmour.art/ws/progress');
        
        this.ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.updateProgress(data.token, data.progress);
        };
    }
    
    trackDownload(token, softwareName) {
        const progressElement = this.createProgressElement(token, softwareName);
        document.body.appendChild(progressElement);
        
        this.downloads.set(token, {
            element: progressElement,
            startTime: Date.now(),
            softwareName: softwareName
        });
    }
    
    updateProgress(token, progress) {
        const download = this.downloads.get(token);
        if (!download) return;
        
        const progressBar = download.element.querySelector('.progress-bar');
        const progressText = download.element.querySelector('.progress-text');
        
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${progress}%`;
        
        if (progress >= 100) {
            setTimeout(() => {
                this.completeDownload(token);
            }, 1000);
        }
    }
}
```

## ğŸ¯ å®æ–½æ—¶é—´è¡¨

### Week 1
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] APIå®‰å…¨å¢å¼º (JWT)
- [ ] åŸºç¡€ç›‘æ§ç³»ç»Ÿ

### Week 2  
- [ ] é”™è¯¯å¤„ç†æ ‡å‡†åŒ–
- [ ] é…ç½®ç®¡ç†ä¼˜åŒ–
- [ ] æ€§èƒ½ç›‘æ§å®æ–½

### Week 3-4
- [ ] Redisç¼“å­˜ç³»ç»Ÿ
- [ ] ç•Œé¢ä¼˜åŒ–æ”¹è¿›
- [ ] å®æ—¶è¿›åº¦æ˜¾ç¤º

### Week 5-6
- [ ] è‡ªåŠ¨åŒ–éƒ¨ç½²
- [ ] æµ‹è¯•è¦†ç›–å¢åŠ 
- [ ] æ–‡æ¡£å®Œå–„

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- APIå“åº”æ—¶é—´ < 200ms (ç›®æ ‡: 100ms)
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ < 50ms
- é¡µé¢åŠ è½½æ—¶é—´ < 2s
- ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%

### å®‰å…¨æŒ‡æ ‡
- 0ä¸ªå®‰å…¨æ¼æ´
- 100%çš„APIè¯·æ±‚é€šè¿‡è®¤è¯
- æ‰€æœ‰æ•æ„Ÿæ“ä½œæœ‰å®¡è®¡æ—¥å¿—

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
- ä¸‹è½½æˆåŠŸç‡ > 99%
- ç”¨æˆ·æ“ä½œå“åº”æ—¶é—´ < 1s
- ç§»åŠ¨ç«¯é€‚é…å®Œæˆåº¦ 100%

---

**ä¸‹ä¸€æ­¥**: è¯·é€‰æ‹©æ‚¨å¸Œæœ›ä¼˜å…ˆå®æ–½çš„ä¼˜åŒ–é¡¹ç›®ï¼Œæˆ‘å¯ä»¥æä¾›å…·ä½“çš„ä»£ç å®ç°å’Œéƒ¨ç½²æŒ‡å¯¼ã€‚
