# 🧹 宝塔面板缓存清理指南

## 问题描述
当网站代码更新后，可能由于各种缓存机制导致新代码不生效，出现以下问题：
- JavaScript文件没有更新
- PHP文件修改后仍执行旧代码
- 下载功能异常
- 配置文件更改不生效

## 🔧 宝塔面板缓存清理步骤

### 1. PHP缓存清理

#### 1.1 OPcache缓存清理
```bash
# 方法1: 通过宝塔面板
1. 登录宝塔面板
2. 点击 "软件商店" → "已安装"
3. 找到 "PHP 7.4" (或对应版本) → "设置"
4. 点击 "性能调整" → "OPcache缓存" → "清空OPcache"

# 方法2: 命令行清理
sudo systemctl reload php-fpm
# 或者
sudo service php7.4-fpm reload
```

#### 1.2 重启PHP-FPM
```bash
# 宝塔面板方式
1. 软件商店 → 已安装 → PHP → 重启

# 命令行方式
sudo systemctl restart php7.4-fpm
```

### 2. Nginx缓存清理

#### 2.1 清理Nginx缓存
```bash
# 宝塔面板方式
1. 软件商店 → 已安装 → Nginx → 重载配置

# 命令行方式
sudo nginx -s reload
```

#### 2.2 清理静态文件缓存
```bash
# 如果启用了Nginx静态文件缓存
sudo rm -rf /www/server/nginx/proxy_cache_dir/*
sudo systemctl reload nginx
```

### 3. 浏览器缓存清理

#### 3.1 强制刷新
- **Chrome/Edge**: `Ctrl + F5` 或 `Ctrl + Shift + R`
- **Firefox**: `Ctrl + F5` 或 `Ctrl + Shift + R`
- **Safari**: `Cmd + Shift + R`

#### 3.2 开发者工具清理
```
1. 按F12打开开发者工具
2. 右键点击刷新按钮
3. 选择 "清空缓存并硬性重新加载"
```

### 4. CDN缓存清理 (如果使用)

#### 4.1 宝塔CDN
```bash
# 如果使用宝塔CDN
1. 宝塔面板 → 网站 → 对应站点 → CDN
2. 点击 "缓存清理" → "全部清理"
```

#### 4.2 其他CDN服务商
- **阿里云CDN**: 控制台 → CDN → 刷新预热
- **腾讯云CDN**: 控制台 → CDN → 缓存刷新
- **百度云CDN**: 控制台 → CDN → 缓存刷新

### 5. 应用级缓存清理

#### 5.1 清理临时文件
```bash
# 清理系统临时文件
sudo rm -rf /tmp/*

# 清理网站临时文件 (根据实际路径调整)
sudo rm -rf /www/wwwroot/your-domain/cache/*
sudo rm -rf /www/wwwroot/your-domain/temp/*
```

#### 5.2 清理下载文件缓存
```bash
# 清理下载器缓存文件
sudo rm -rf /www/wwwroot/dw.ytmour.art/downloads/*
```

## 🚀 一键清理脚本

创建一个清理脚本 `clear_cache.sh`：

```bash
#!/bin/bash
echo "🧹 开始清理所有缓存..."

# 1. 清理PHP缓存
echo "1. 清理PHP缓存..."
sudo systemctl reload php7.4-fpm

# 2. 清理Nginx缓存
echo "2. 重载Nginx配置..."
sudo nginx -s reload

# 3. 清理临时文件
echo "3. 清理临时文件..."
sudo rm -rf /tmp/php_*
sudo rm -rf /tmp/nginx_*

# 4. 清理下载文件 (可选)
echo "4. 清理下载文件..."
# sudo rm -rf /www/wwwroot/dw.ytmour.art/downloads/*

echo "✅ 缓存清理完成！"
echo "请在浏览器中按 Ctrl+F5 强制刷新页面"
```

使用方法：
```bash
chmod +x clear_cache.sh
sudo ./clear_cache.sh
```

## 🔍 验证缓存清理效果

### 1. 检查PHP文件更新
```php
<?php
// 在PHP文件中添加时间戳验证
echo "当前时间: " . date('Y-m-d H:i:s') . "\n";
echo "文件修改时间: " . date('Y-m-d H:i:s', filemtime(__FILE__)) . "\n";
?>
```

### 2. 检查JavaScript文件更新
```javascript
// 在JS文件中添加版本号
console.log('脚本版本: v8.0 - ' + new Date().toISOString());
```

### 3. 检查网络请求
```
1. 打开浏览器开发者工具 (F12)
2. 切换到 "Network" 标签
3. 勾选 "Disable cache"
4. 刷新页面查看请求
```

## ⚠️ 注意事项

1. **生产环境操作**: 在生产环境清理缓存前，建议先在测试环境验证
2. **备份重要数据**: 清理前确保重要数据已备份
3. **逐步清理**: 建议按步骤逐个清理，便于定位问题
4. **监控服务状态**: 清理后检查服务是否正常运行

## 🎯 针对当前项目的特殊处理

### 清理下载拦截器缓存
```bash
# 1. 清理浏览器中的JavaScript缓存
# 在浏览器控制台执行：
localStorage.clear();
sessionStorage.clear();

# 2. 强制重新加载拦截器
# 在页面中添加版本参数：
<script src="interceptor.js?v=8.0&t=<?php echo time(); ?>"></script>
```

### 验证修复效果
```javascript
// 在浏览器控制台检查版本
console.log('当前拦截器版本:', window.downloadInterceptor ? 'v8.0' : '未加载');
```

---

**最后更新**: 2025-01-09  
**适用版本**: 宝塔面板 7.x + PHP 7.4+ + Nginx 1.x
